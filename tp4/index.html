<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Les Travaux Pratiques du cours Big Data"><meta name=author content="Lilia Sfaxi"><link href=http://INSATunisia.github.io/TP-BigData/tp4/ rel=canonical><link rel=icon href=../img/favicon.ico><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.10"><title>TP4 - Stockage de Données dans une Base NOSQL avec HBase - TP Big Data</title><link rel=stylesheet href=../assets/stylesheets/main.d6be258b.min.css><link rel=stylesheet href=../assets/stylesheets/palette.e6a45f82.min.css><meta name=theme-color content=#2094f3><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../css/timeago.css><link rel=stylesheet href=../stylesheets/extra.css><link rel=stylesheet href=../stylesheets/links.css><script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=blue data-md-color-accent=yellow> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#telecharger-pdf class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="TP Big Data" class="md-header__button md-logo" aria-label="TP Big Data" data-md-component=logo> <img src=../img/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> TP Big Data </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> TP4 - Stockage de Données dans une Base NOSQL avec HBase </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/INSATunisia/TP-BigData/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> INSATunisia/TP-BigData </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="TP Big Data" class="md-nav__button md-logo" aria-label="TP Big Data" data-md-component=logo> <img src=../img/logo.png alt=logo> </a> TP Big Data </label> <div class=md-nav__source> <a href=https://github.com/INSATunisia/TP-BigData/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> INSATunisia/TP-BigData </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Travaux Pratiques Big Data </a> </li> <li class=md-nav__item> <a href=../tp1/ class=md-nav__link> TP1 - Le traitement Batch avec Hadoop HDFS et Map Reduce </a> </li> <li class=md-nav__item> <a href=../tp2/ class=md-nav__link> TP2 - Traitement par Lot et Streaming avec Spark </a> </li> <li class=md-nav__item> <a href=../tp3/ class=md-nav__link> TP3 - La Collecte de Données avec le Bus Kafka </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> TP4 - Stockage de Données dans une Base NOSQL avec HBase <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> TP4 - Stockage de Données dans une Base NOSQL avec HBase </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#telecharger-pdf class=md-nav__link> Télécharger PDF </a> </li> <li class=md-nav__item> <a href=#objectifs-du-tp class=md-nav__link> Objectifs du TP </a> </li> <li class=md-nav__item> <a href=#outils-et-versions class=md-nav__link> Outils et Versions </a> </li> <li class=md-nav__item> <a href=#apache-hbase class=md-nav__link> Apache HBase </a> <nav class=md-nav aria-label="Apache HBase"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#presentation class=md-nav__link> Présentation </a> </li> <li class=md-nav__item> <a href=#modele-de-donnees class=md-nav__link> Modèle de données </a> </li> <li class=md-nav__item> <a href=#architecture class=md-nav__link> Architecture </a> </li> <li class=md-nav__item> <a href=#installation class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#premiere-manipulation-de-hbase class=md-nav__link> Première manipulation de HBase </a> <nav class=md-nav aria-label="Première manipulation de HBase"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#hbase-shell class=md-nav__link> HBase Shell </a> </li> <li class=md-nav__item> <a href=#hbase-api class=md-nav__link> HBase API </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#traitement-de-donnees-avec-spark class=md-nav__link> Traitement de données avec Spark </a> </li> <li class=md-nav__item> <a href=#homework class=md-nav__link> Homework </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#telecharger-pdf class=md-nav__link> Télécharger PDF </a> </li> <li class=md-nav__item> <a href=#objectifs-du-tp class=md-nav__link> Objectifs du TP </a> </li> <li class=md-nav__item> <a href=#outils-et-versions class=md-nav__link> Outils et Versions </a> </li> <li class=md-nav__item> <a href=#apache-hbase class=md-nav__link> Apache HBase </a> <nav class=md-nav aria-label="Apache HBase"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#presentation class=md-nav__link> Présentation </a> </li> <li class=md-nav__item> <a href=#modele-de-donnees class=md-nav__link> Modèle de données </a> </li> <li class=md-nav__item> <a href=#architecture class=md-nav__link> Architecture </a> </li> <li class=md-nav__item> <a href=#installation class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#premiere-manipulation-de-hbase class=md-nav__link> Première manipulation de HBase </a> <nav class=md-nav aria-label="Première manipulation de HBase"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#hbase-shell class=md-nav__link> HBase Shell </a> </li> <li class=md-nav__item> <a href=#hbase-api class=md-nav__link> HBase API </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#traitement-de-donnees-avec-spark class=md-nav__link> Traitement de données avec Spark </a> </li> <li class=md-nav__item> <a href=#homework class=md-nav__link> Homework </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/INSATunisia/TP-BigData/edit/master/docs/tp4.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>TP4 - Stockage de Données dans une Base NOSQL avec HBase</h1> <p><center><img alt="Distributed Data Base" src=../img/ddb.jpg></center></p> <h3 id=telecharger-pdf>Télécharger PDF<a class=headerlink href=#telecharger-pdf title="Permanent link">&para;</a></h3> <p><a href=tp4.pdf><img alt="Download TP4" src=../img/pdf.png></a></p> <h3 id=objectifs-du-tp>Objectifs du TP<a class=headerlink href=#objectifs-du-tp title="Permanent link">&para;</a></h3> <p>Manipulation de données avec HBase, et traitement co-localisé avec Spark.</p> <h3 id=outils-et-versions>Outils et Versions<a class=headerlink href=#outils-et-versions title="Permanent link">&para;</a></h3> <ul> <li><a href=https://hbase.apache.org/ >Apache HBase</a> Version 2.5.8</li> <li><a href=http://hadoop.apache.org/ >Apache Hadoop</a> Version: 3.3.6</li> <li><a href=https://spark.apache.org/ >Apache Spark</a> Version: 3.5.0</li> <li><a href=https://www.docker.com/ >Docker</a> Version <em>latest</em></li> <li><a href=https://code.visualstudio.com/ >Visual Studio Code</a> Version 1.85.1 (ou tout autre IDE de votre choix)</li> <li><a href=http://www.oracle.com/technetwork/java/javase/downloads/index.html>Java</a> Version 1.8.</li> <li>Unix-like ou Unix-based Systems (Divers Linux et MacOS)</li> </ul> <h3 id=apache-hbase>Apache HBase<a class=headerlink href=#apache-hbase title="Permanent link">&para;</a></h3> <h4 id=presentation>Présentation<a class=headerlink href=#presentation title="Permanent link">&para;</a></h4> <p>HBase est un système de gestion de bases de données distribué, non-relationnel et orienté colonnes, développé au-dessus du système de fichier HDFS. Il permet un accès aléatoire en écriture/lecture en temps réel à un très grand ensemble de données. <center> <img alt="Apache HBase" src=../img/hbase.png> </center></p> <h4 id=modele-de-donnees>Modèle de données<a class=headerlink href=#modele-de-donnees title="Permanent link">&para;</a></h4> <p>Le modèle se base sur six concepts, qui sont :</p> <ul> <li><strong>Table</strong> : dans HBase les données sont organisées dans des tables. Les noms des tables sont des chaînes de caractères.</li> <li><strong>Row</strong> : dans chaque table, les données sont organisées dans des lignes. Une ligne est identifiée par une clé unique (<em>RowKey</em>). La Rowkey n’a pas de type, elle est traitée comme un tableau d’octets.</li> <li><strong>Column Family</strong> : Les données au sein d’une ligne sont regroupées par <em>column family</em>. Chaque ligne de la table a les mêmes column families, qui peuvent être peuplées ou pas. Les column families sont définies à la création de la table dans HBase. Les noms des column families sont des chaînes de caractères.</li> <li><strong>Column qualifier</strong> : L’accès aux données au sein d’une column family se fait via le <em>column qualifier</em> ou <em>column</em>. Ce dernier n’est pas spécifié à la création de la table mais plutôt à l’insertion de la donnée. Comme les rowkeys, le column qualifier n’est pas typé, il est traité comme un tableau d’octets.</li> <li><strong>Cell</strong> : La combinaison du RowKey, de la Column Family ainsi que la Column qualifier identifie d’une manière unique une cellule. Les données stockées dans une cellule sont appelées les <em>valeurs</em> de cette cellule. Les valeurs n’ont pas de type, ils sont toujours considérés comme tableaux d’octets.</li> <li><strong>Version</strong> : Les valeurs au sein d’une cellule sont versionnés. Les versions sont identifiés par leur <em>timestamp</em> (de type long). Le nombre de versions est configuré via la Column Family. Par défaut, ce nombre est égal à trois.</li> </ul> <p><center> <img alt="Modèle de données de HBase" src=../img/tp4/hbase-model.jpg> </center></p> <p>Les données dans HBase sont stockées sous forme de <em>HFiles</em>, par colonnes, dans HDFS. Chaque <em>HFile</em> se charge de stocker des données correspondantes à une <em>column family</em> particulière.</p> <p><center> <img alt=HFile src=../img/tp4/hbase-hfile.png> </center></p> <p>Autres caractéristiques de HBase:</p> <ul> <li>HBase n'a pas de schéma prédéfini, sauf qu'il faut définir les familles de colonnes à la création des tables, car elles représentent l'organisation physique des données</li> <li>HBase est décrite comme étant un magasin de données clef/valeur, où la clef est la combinaison (<em>row</em>-<em>column family</em>-<em>column</em>-<em>timestamp</em>) représente la clef, et la <em>cell</em> représente la valeur.</li> </ul> <h4 id=architecture>Architecture<a class=headerlink href=#architecture title="Permanent link">&para;</a></h4> <p>Physiquement, HBase est composé de trois types de serveurs de type Master/Worker.</p> <ul> <li><strong>Region Servers</strong>: permettent de fournir les données pour lectures et écritures. Pour accéder aux données, les clients communiquent avec les RegionServers directement.</li> <li><strong>HBase HMaster</strong> : gère l'affectation des régions, les opérations de création et suppression de tables.</li> <li><strong>Zookeeper</strong>: permet de maintenir le cluster en état.</li> </ul> <p>Le DataNode de Hadoop permet de stocker les données que le Region Server gère. Toutes les données de HBase sont stockées dans des fichiers HDFS. Les RegionServers sont colocalisés avec les DataNodes.</p> <p>Le NameNode permet de maintenir les métadonnées sur tous les blocs physiques qui forment les fichiers.</p> <p><center> <img alt="Architecture de HBase" src=../img/tp4/hbase-archi.png> </center></p> <p>Les tables HBase sont divisées horizontalement, par <em>row</em> en plusieurs <strong>Regions</strong>. Une region contient toutes les lignes de la table comprises entre deux clefs données. Les regions sont affectées à des noeuds dans le cluster, appelés <em>Region Servers</em>, qui permettent de servir les données pour la lecture et l'écriture. Un <em>region server</em> peut servir jusqu'à 1000 régions.</p> <p>Le HBase Master est responsable de coordonner les <em>region servers</em> en assignant les régions au démarrage, les réassignant en cas de récupération ou d'équilibrage de charge, et en faisant le monitoring des instances des <em>region servers</em> dans le cluster. Il permet également de fournir une interface pour la création, la suppression et la modification des tables.</p> <p>HBase utilise Zookeeper comme service de coordination pour maintenir l'état du serveur dans le cluster. Zookeeper sait quels serveurs sont actifs et disponibles, et fournit une notification en cas d'échec d'un serveur.</p> <h4 id=installation>Installation<a class=headerlink href=#installation title="Permanent link">&para;</a></h4> <p>HBase est installé sur le même cluster que précédemment. Suivre les étapes décrites dans la partie <em>Installation</em> du <a href=tp1/index.html#installation>TP1</a> pour télécharger l'image et exécuter les trois contenaires. Si cela est déjà fait, il suffit de lancer vos machines grâce aux commandes suivantes:</p> <div class=highlight><pre><span></span><code>  docker start hadoop-master hadoop-worker1 hadoop-worker2
</code></pre></div> <p>puis d'entrer dans le contenaire master:</p> <div class=highlight><pre><span></span><code>    docker <span class=nb>exec</span> -it hadoop-master bash
</code></pre></div> <p>Lancer ensuite les démons yarn et hdfs: <div class=highlight><pre><span></span><code>  ./start-hadoop.sh
</code></pre></div></p> <p>Lancer HBase en tapant : <div class=highlight><pre><span></span><code>  start-hbase.sh
</code></pre></div></p> <p>Une fois c'est fait, en tapant <code>jps</code>, vous devriez avoir un résultat ressemblant au suivant:</p> <p><div class=highlight><pre><span></span><code><span class=m>161</span> NameNode
<span class=m>1138</span> HRegionServer
<span class=m>499</span> ResourceManager
<span class=m>1028</span> HMaster
<span class=m>966</span> HQuorumPeer
<span class=m>1499</span> Jps
<span class=m>348</span> SecondaryNameNode
</code></pre></div> Vous remarquerez que tous les démons Hadoop (NameNode, SecondaryNameNode et ResourceManager) ainsi que les démons HBase (HRegionServer, HMaster et HQuorumPeer (Zookeeper)) sont démarrés.</p> <h3 id=premiere-manipulation-de-hbase>Première manipulation de HBase<a class=headerlink href=#premiere-manipulation-de-hbase title="Permanent link">&para;</a></h3> <h4 id=hbase-shell>HBase Shell<a class=headerlink href=#hbase-shell title="Permanent link">&para;</a></h4> <p>Pour manipuler votre base de données avec son shell interactif, vous devez lancer le script suivant: <div class=highlight><pre><span></span><code>  hbase shell
</code></pre></div></p> <p>Vous obtiendrez une interface ressemblant à la suivante: <center> <img alt="HBase shell" src=../img/tp4/hbase-shell.png> </center></p> <p>Nous allons créer une base de données qui contient les données suivantes:</p> <p><center> <img alt="HBase Exemple" src=../img/tp4/hbase-table-1.png> </center></p> <ol> <li>Commençons par créer la table, ainsi que les familles de colonnes associées: <div class=highlight><pre><span></span><code>create <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;customer&#39;</span>,<span class=s1>&#39;sales&#39;</span>
</code></pre></div></li> <li>Vérifier que la table est bien créée: <div class=highlight><pre><span></span><code>list
</code></pre></div> Vous devriez obtenir le résultat suivant: <center> <img alt="HBase shell list" src=../img/tp4/hbase-list.png> </center></li> <li>Insérer les différentes lignes: <div class=highlight><pre><span></span><code>put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;101&#39;</span>,<span class=s1>&#39;customer:name&#39;</span>,<span class=s1>&#39;John White&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;101&#39;</span>,<span class=s1>&#39;customer:city&#39;</span>,<span class=s1>&#39;Los Angeles, CA&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;101&#39;</span>,<span class=s1>&#39;sales:product&#39;</span>,<span class=s1>&#39;Chairs&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;101&#39;</span>,<span class=s1>&#39;sales:amount&#39;</span>,<span class=s1>&#39;$400.00&#39;</span>

put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;102&#39;</span>,<span class=s1>&#39;customer:name&#39;</span>,<span class=s1>&#39;Jane Brown&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;102&#39;</span>,<span class=s1>&#39;customer:city&#39;</span>,<span class=s1>&#39;Atlanta, GA&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;102&#39;</span>,<span class=s1>&#39;sales:product&#39;</span>,<span class=s1>&#39;Lamps&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;102&#39;</span>,<span class=s1>&#39;sales:amount&#39;</span>,<span class=s1>&#39;$200.00&#39;</span>

put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;103&#39;</span>,<span class=s1>&#39;customer:name&#39;</span>,<span class=s1>&#39;Bill Green&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;103&#39;</span>,<span class=s1>&#39;customer:city&#39;</span>,<span class=s1>&#39;Pittsburgh, PA&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;103&#39;</span>,<span class=s1>&#39;sales:product&#39;</span>,<span class=s1>&#39;Desk&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;103&#39;</span>,<span class=s1>&#39;sales:amount&#39;</span>,<span class=s1>&#39;$500.00&#39;</span>

put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;104&#39;</span>,<span class=s1>&#39;customer:name&#39;</span>,<span class=s1>&#39;Jack Black&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;104&#39;</span>,<span class=s1>&#39;customer:city&#39;</span>,<span class=s1>&#39;St. Louis, MO&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;104&#39;</span>,<span class=s1>&#39;sales:product&#39;</span>,<span class=s1>&#39;Bed&#39;</span>
put <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;104&#39;</span>,<span class=s1>&#39;sales:amount&#39;</span>,<span class=s1>&#39;$1,600.00&#39;</span>
</code></pre></div></li> <li>Visualiser le résultat de l'insertion, en tapant: <div class=highlight><pre><span></span><code>scan <span class=s1>&#39;sales_ledger&#39;</span>
</code></pre></div> <center> <img alt="HBase shell scan" src=../img/tp4/hbase-scan.png> </center></li> <li>Afficher les valeurs de la colonne <em>product</em> de la ligne <em>102</em> <div class=highlight><pre><span></span><code>get <span class=s1>&#39;sales_ledger&#39;</span>,<span class=s1>&#39;102&#39;</span>,<span class=o>{</span><span class=nv>COLUMN</span> <span class=o>=</span>&gt; <span class=s1>&#39;sales:product&#39;</span><span class=o>}</span>
</code></pre></div> Vous obtiendrez: <center> <img alt="HBase shell get" src=../img/tp4/hbase-get.png> </center></li> <li>Vous pourrez quitter le shell en tapant: <div class=highlight><pre><span></span><code><span class=nb>exit</span>
</code></pre></div></li> </ol> <h4 id=hbase-api>HBase API<a class=headerlink href=#hbase-api title="Permanent link">&para;</a></h4> <p>HBase fournit une API en Java pour pouvoir manipuler programmatiquement les données de la base. Nous allons montrer ici un exemple très simple.</p> <ol> <li>Dans votre contenaire principal, créer un répertoire <em>hbase-code</em> à l'emplacement de votre choix, puis déplacez-vous dedans. <div class=highlight><pre><span></span><code>mkdir hbase-code
<span class=nb>cd</span> hbase-code
</code></pre></div></li> <li>Créer un projet maven intitulé <em>hello-hbase</em> dans ce répertoire (maven est déjà installé): <div class=highlight><pre><span></span><code>mvn archetype:generate -DgroupId<span class=o>=</span>tn.insat.tp4 -DartifactId<span class=o>=</span>hello-hbase -DarchetypeArtifactId<span class=o>=</span>maven-archetype-quickstart -DinteractiveMode<span class=o>=</span><span class=nb>false</span>
</code></pre></div></li> <li>Créer et ouvrir le fichier <em>HelloHBase.java</em> sous le répertoire tp4 (J'utilise <code>vim</code> ici, qui est déjà installé): <div class=highlight><pre><span></span><code><span class=nb>cd</span> hello-hbase
vim src/main/java/tn/insat/tp4/HelloHBase.java
</code></pre></div></li> <li> <p>Insérer le code suivant dans le fichier: <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tp4</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.apache.hadoop.conf.Configuration</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.HBaseConfiguration</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.TableName</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.client.*</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.util.Bytes</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>java.io.IOException</span><span class=p>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>HelloHBase</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=n>Table</span> <span class=n>table1</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>tableName</span> <span class=o>=</span> <span class=s>&quot;user&quot;</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>family1</span> <span class=o>=</span> <span class=s>&quot;PersonalData&quot;</span><span class=p>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>family2</span> <span class=o>=</span> <span class=s>&quot;ProfessionalData&quot;</span><span class=p>;</span>

    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>createHbaseTable</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=n>Configuration</span> <span class=n>config</span> <span class=o>=</span> <span class=n>HBaseConfiguration</span><span class=p>.</span><span class=na>create</span><span class=p>();</span>
        <span class=k>try</span> <span class=p>(</span><span class=n>Connection</span> <span class=n>connection</span> <span class=o>=</span> <span class=n>ConnectionFactory</span><span class=p>.</span><span class=na>createConnection</span><span class=p>(</span><span class=n>config</span><span class=p>);</span>
             <span class=n>Admin</span> <span class=n>admin</span> <span class=o>=</span> <span class=n>connection</span><span class=p>.</span><span class=na>getAdmin</span><span class=p>())</span> <span class=p>{</span>

            <span class=c1>// Create table with column families</span>
            <span class=n>TableDescriptor</span> <span class=n>tableDescriptor</span> <span class=o>=</span> <span class=n>TableDescriptorBuilder</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>(</span><span class=n>TableName</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>tableName</span><span class=p>))</span>
                <span class=p>.</span><span class=na>setColumnFamily</span><span class=p>(</span><span class=n>ColumnFamilyDescriptorBuilder</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>family1</span><span class=p>))</span>
                <span class=p>.</span><span class=na>setColumnFamily</span><span class=p>(</span><span class=n>ColumnFamilyDescriptorBuilder</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>family2</span><span class=p>))</span>
                <span class=p>.</span><span class=na>build</span><span class=p>();</span>

            <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Connecting&quot;</span><span class=p>);</span>
            <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Creating Table&quot;</span><span class=p>);</span>
            <span class=n>createOrOverwrite</span><span class=p>(</span><span class=n>admin</span><span class=p>,</span> <span class=n>tableDescriptor</span><span class=p>);</span>
            <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Done......&quot;</span><span class=p>);</span>

            <span class=n>table1</span> <span class=o>=</span> <span class=n>connection</span><span class=p>.</span><span class=na>getTable</span><span class=p>(</span><span class=n>TableName</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>tableName</span><span class=p>));</span>

            <span class=k>try</span> <span class=p>{</span>
                <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Adding user: user1&quot;</span><span class=p>);</span>
                <span class=kt>byte</span><span class=o>[]</span> <span class=n>row1</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;user1&quot;</span><span class=p>);</span>
                <span class=n>Put</span> <span class=n>p</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Put</span><span class=p>(</span><span class=n>row1</span><span class=p>);</span>
                <span class=n>p</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family1</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;name&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;ahmed&quot;</span><span class=p>));</span>
                <span class=n>p</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family1</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;address&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;tunis&quot;</span><span class=p>));</span>
                <span class=n>p</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family2</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;company&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;biat&quot;</span><span class=p>));</span>
                <span class=n>p</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family2</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;salary&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;10000&quot;</span><span class=p>));</span>
                <span class=n>table1</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>

                <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Adding user: user2&quot;</span><span class=p>);</span>
                <span class=kt>byte</span><span class=o>[]</span> <span class=n>row2</span> <span class=o>=</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;user2&quot;</span><span class=p>);</span>
                <span class=n>Put</span> <span class=n>p2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Put</span><span class=p>(</span><span class=n>row2</span><span class=p>);</span>
                <span class=n>p2</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family1</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;name&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;imen&quot;</span><span class=p>));</span>
                <span class=n>p2</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family1</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;tel&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;21212121&quot;</span><span class=p>));</span>
                <span class=n>p2</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family2</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;profession&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;educator&quot;</span><span class=p>));</span>
                <span class=n>p2</span><span class=p>.</span><span class=na>addColumn</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family2</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;company&quot;</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;insat&quot;</span><span class=p>));</span>
                <span class=n>table1</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>p2</span><span class=p>);</span>

                <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;Reading data...&quot;</span><span class=p>);</span>
                <span class=n>Get</span> <span class=n>g</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Get</span><span class=p>(</span><span class=n>row1</span><span class=p>);</span>
                <span class=n>Result</span> <span class=n>r</span> <span class=o>=</span> <span class=n>table1</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>g</span><span class=p>);</span>
                <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>getValue</span><span class=p>(</span><span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=n>family1</span><span class=p>),</span> <span class=n>Bytes</span><span class=p>.</span><span class=na>toBytes</span><span class=p>(</span><span class=s>&quot;name&quot;</span><span class=p>))));</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>table1</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>table1</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>createOrOverwrite</span><span class=p>(</span><span class=n>Admin</span> <span class=n>admin</span><span class=p>,</span> <span class=n>TableDescriptor</span> <span class=n>table</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>admin</span><span class=p>.</span><span class=na>tableExists</span><span class=p>(</span><span class=n>table</span><span class=p>.</span><span class=na>getTableName</span><span class=p>()))</span> <span class=p>{</span>
            <span class=n>admin</span><span class=p>.</span><span class=na>disableTable</span><span class=p>(</span><span class=n>table</span><span class=p>.</span><span class=na>getTableName</span><span class=p>());</span>
            <span class=n>admin</span><span class=p>.</span><span class=na>deleteTable</span><span class=p>(</span><span class=n>table</span><span class=p>.</span><span class=na>getTableName</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=n>admin</span><span class=p>.</span><span class=na>createTable</span><span class=p>(</span><span class=n>table</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
        <span class=n>HelloHBase</span> <span class=n>admin</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HelloHBase</span><span class=p>();</span>
        <span class=n>admin</span><span class=p>.</span><span class=na>createHbaseTable</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> Ce code Java utilise l'API Apache HBase pour interagir avec une base de données HBase :</p> <ul> <li><strong>Création ou mise à jour d'une table</strong> : Il crée ou remplace une table HBase nommée user qui contient deux familles de colonnes, PersonalData et ProfessionalData.</li> <li><strong>Insertion de données</strong> : Il ajoute deux enregistrements dans la table user. Le premier enregistrement pour l'utilisateur user1 inclut des informations personnelles et professionnelles comme le nom, l'adresse, la compagnie et le salaire. Le deuxième enregistrement, pour l'utilisateur user2, inclut également des informations personnelles et professionnelles comme le nom, le téléphone, la profession et la compagnie.</li> <li><strong>Lecture de données</strong> : Après l'insertion, il lit et affiche la valeur de la colonne name sous la famille de colonnes PersonalData pour l'utilisateur user1.</li> </ul> <p>Ce script gère également la connexion et la fermeture de la table ainsi que la gestion administrative de la base de données HBase, s'assurant que la table existe, la créant si nécessaire, et la recréant si elle existait déjà.</p> </li> <li> <p>Ouvrir le fichier <em>pom.xml</em> et saisir les informations suivantes: <div class=highlight><pre><span></span><code><span class=nt>&lt;project</span> <span class=na>xmlns=</span><span class=s>&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class=na>xmlns:xsi=</span><span class=s>&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class=na>xsi:schemaLocation=</span><span class=s>&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span><span class=nt>&gt;</span>
  <span class=nt>&lt;modelVersion&gt;</span>4.0.0<span class=nt>&lt;/modelVersion&gt;</span>
  <span class=nt>&lt;groupId&gt;</span>tn.insat<span class=nt>&lt;/groupId&gt;</span>
  <span class=nt>&lt;artifactId&gt;</span>hello-hbase<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;packaging&gt;</span>jar<span class=nt>&lt;/packaging&gt;</span>
  <span class=nt>&lt;version&gt;</span>1.0-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
  <span class=nt>&lt;name&gt;</span>hello-hbase<span class=nt>&lt;/name&gt;</span>
  <span class=nt>&lt;url&gt;</span>http://maven.apache.org<span class=nt>&lt;/url&gt;</span>
  <span class=nt>&lt;dependencies&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
      <span class=nt>&lt;groupId&gt;</span>junit<span class=nt>&lt;/groupId&gt;</span>
      <span class=nt>&lt;artifactId&gt;</span>junit<span class=nt>&lt;/artifactId&gt;</span>
      <span class=nt>&lt;version&gt;</span>3.8.1<span class=nt>&lt;/version&gt;</span>
      <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>slf4j-api<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>2.0.13<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>

    <span class=cm>&lt;!-- HBase dependencies --&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>org.apache.hbase<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>hbase-client<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>2.5.8<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;exclusions&gt;</span>
            <span class=nt>&lt;exclusion&gt;</span>
                    <span class=nt>&lt;groupId&gt;</span>org.apache.hadoop<span class=nt>&lt;/groupId&gt;</span>
                    <span class=nt>&lt;artifactId&gt;</span>*<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;/exclusion&gt;</span>
        <span class=nt>&lt;/exclusions&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>org.apache.hbase<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>hbase-common<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>2.5.8<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;exclusions&gt;</span>
            <span class=nt>&lt;exclusion&gt;</span>
                    <span class=nt>&lt;groupId&gt;</span>org.apache.hadoop<span class=nt>&lt;/groupId&gt;</span>
                    <span class=nt>&lt;artifactId&gt;</span>*<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;/exclusion&gt;</span>
        <span class=nt>&lt;/exclusions&gt;</span>

    <span class=nt>&lt;/dependency&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>org.apache.hbase<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>hbase-server<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>2.5.8<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;exclusions&gt;</span>
            <span class=nt>&lt;exclusion&gt;</span>
                    <span class=nt>&lt;groupId&gt;</span>org.apache.hadoop<span class=nt>&lt;/groupId&gt;</span>
                    <span class=nt>&lt;artifactId&gt;</span>*<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;/exclusion&gt;</span>
        <span class=nt>&lt;/exclusions&gt;</span>

    <span class=nt>&lt;/dependency&gt;</span>

    <span class=cm>&lt;!-- Hadoop dependencies --&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>org.apache.hadoop<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>hadoop-common<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>3.3.6<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>org.apache.hadoop<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>hadoop-hdfs-client<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>3.3.6<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
  <span class=nt>&lt;/dependencies&gt;</span>
  <span class=nt>&lt;build&gt;</span>
    <span class=nt>&lt;plugins&gt;</span>
        <span class=nt>&lt;plugin&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>3.8.1<span class=nt>&lt;/version&gt;</span>
            <span class=nt>&lt;configuration&gt;</span>
                <span class=nt>&lt;source&gt;</span>1.8<span class=nt>&lt;/source&gt;</span>
                <span class=nt>&lt;target&gt;</span>1.8<span class=nt>&lt;/target&gt;</span>
            <span class=nt>&lt;/configuration&gt;</span>
        <span class=nt>&lt;/plugin&gt;</span>
        <span class=nt>&lt;plugin&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>maven-jar-plugin<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>3.2.0<span class=nt>&lt;/version&gt;</span>
            <span class=nt>&lt;configuration&gt;</span>
                <span class=nt>&lt;archive&gt;</span>
                    <span class=nt>&lt;manifest&gt;</span>
                        <span class=nt>&lt;addClasspath&gt;</span>true<span class=nt>&lt;/addClasspath&gt;</span>
                        <span class=nt>&lt;mainClass&gt;</span>tn.insat.tp4.HelloHBase<span class=nt>&lt;/mainClass&gt;</span>
                    <span class=nt>&lt;/manifest&gt;</span>
                <span class=nt>&lt;/archive&gt;</span>
            <span class=nt>&lt;/configuration&gt;</span>
    <span class=nt>&lt;/plugin&gt;</span>
    <span class=nt>&lt;plugin&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>maven-dependency-plugin<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>3.1.2<span class=nt>&lt;/version&gt;</span> 
            <span class=nt>&lt;executions&gt;</span>
                <span class=nt>&lt;execution&gt;</span>
                    <span class=nt>&lt;id&gt;</span>copy-dependencies<span class=nt>&lt;/id&gt;</span>
                    <span class=nt>&lt;phase&gt;</span>prepare-package<span class=nt>&lt;/phase&gt;</span>
                    <span class=nt>&lt;goals&gt;</span>
                        <span class=nt>&lt;goal&gt;</span>copy-dependencies<span class=nt>&lt;/goal&gt;</span>
                    <span class=nt>&lt;/goals&gt;</span>
                    <span class=nt>&lt;configuration&gt;</span>
                        <span class=nt>&lt;outputDirectory&gt;</span>lib<span class=nt>&lt;/outputDirectory&gt;</span>
                    <span class=nt>&lt;/configuration&gt;</span>
                <span class=nt>&lt;/execution&gt;</span>
            <span class=nt>&lt;/executions&gt;</span>
    <span class=nt>&lt;/plugin&gt;</span>
 <span class=nt>&lt;/plugins&gt;</span>
<span class=nt>&lt;/build&gt;</span>

<span class=nt>&lt;/project&gt;</span>
</code></pre></div> Ce fichier de configuration permet de télécharger toutes les dépendances nécessaires au projet. De plus, il définit les plugins suivants:</p> <ul> <li>Le plugin <code>maven-compiler-plugin</code> est configuré pour utiliser Java 8 (source et target 1.8).</li> <li>Le plugin <code>maven-jar-plugin</code> définit la classe principale et ajuste le chemin de classe pour l'exécution.</li> <li>Le plugin <code>maven-dependency-plugin</code> est utilisé pour copier toutes les dépendances dans un répertoire lib, facilitant l'exécution et la distribution.</li> </ul> </li> <li> <p>Tout en restant sous le répertoire <em>hbase-code</em>, compiler et générer l'exécutable du projet: <div class=highlight><pre><span></span><code>mvn clean package
</code></pre></div></p> </li> <li> <p>Exécuter ce code: <div class=highlight><pre><span></span><code>java -cp <span class=s2>&quot;target/hello-hbase-1.0-SNAPSHOT.jar:lib/*&quot;</span> tn.insat.tp4.HelloHBase
</code></pre></div> Le résultat devrait ressembler au suivant: <center> <img alt="HBase API result" src=../img/tp4/hbase-api.png> </center></p> </li> </ol> <!-- 
## Chargement de fichiers
Il est possible de charger des fichiers volumineux dans la base HBase, à partir de HDFS. Nous vous fournissons pour cela le fichier [purchases2.txt](data/purchases2.txt).
!!! tip "Remarque"
      Ce fichier n'est autre que le fichier _purchases.txt_, légèrement modifié: un numéro unique est rajouté au début de chaque ligne, que nous utiliserons comme clef pour chaque enregistrement, et la séparation entre les colonnes a été remplacée par une virgule (,) au lieu d'une tabluation.
1. Commencer par charger le fichier dans le répertoire _input_ de HDFS (mais d'abord, créer ce répertoire s'il n'existe pas déjà):
<div class="highlight"><pre><span></span><code>hadoop fs -mkdir -p input2
hdfs dfs -put ~/purchases2.txt input2
</code></pre></div>
1. Créer la base _products_ avec une famille de colonnes _cf_
<div class="highlight"><pre><span></span><code>hbase shell
create <span class="s1">&#39;products&#39;</span>,<span class="s1">&#39;cf&#39;</span>
<span class="nb">exit</span>
</code></pre></div>
1. Exécuter la commande suivante, qui permet de charger des données au format _tsv_ dans HBase. Elle permet de déclencher une opération MapReduce sur le fichier principal stocké dans HDFS, pour lire les données puis les insérer via des _put_ dans la base.
<div class="highlight"><pre><span></span><code>hbase org.apache.hadoop.hbase.mapreduce.ImportTsv -Dimporttsv.separator<span class="o">=</span><span class="s1">&#39;,&#39;</span> -Dimporttsv.columns<span class="o">=</span>HBASE_ROW_KEY,cf:date,cf:time,cf:town,cf:product,cf:price,cf:payment products input2
</code></pre></div>
1. Vérifier que la base a bien été créée en consultant la ville de l'enregistrement numéro 2000:
<div class="highlight"><pre><span></span><code>hbase shell
get <span class="s1">&#39;products&#39;</span>,<span class="s1">&#39;2000&#39;</span>,<span class="o">{</span><span class="nv">COLUMN</span> <span class="o">=</span>&gt; <span class="s1">&#39;cf:town&#39;</span><span class="o">}</span>
</code></pre></div>
Vous devriez obtenir le résultat suivant:
<center>
![HBase Bulk Load](img/tp4/hbase-bulk.png)
</center> --> <h3 id=traitement-de-donnees-avec-spark>Traitement de données avec Spark<a class=headerlink href=#traitement-de-donnees-avec-spark title="Permanent link">&para;</a></h3> <p>Installé sur le même cluster que HBase, Spark peut être utilisé pour réaliser des traitements complexes sur les données de HBase. Pour cela, les différents Executors de Spark seront co-localisés avec les region servers, et pourront réaliser des traitements parallèles directement là où les données sont stockées.</p> <p><center> <img alt="HBase et Spark" src=../img/tp4/hbase-spark.png> </center></p> <p>Nous allons réaliser un traitement simple pour montrer comment greffer spark sur HBase.</p> <ol> <li>Créer un nouveau projet Maven. <div class=highlight><pre><span></span><code>mvn archetype:generate -DgroupId<span class=o>=</span>tn.insat.tp4 -DartifactId<span class=o>=</span>hbase-spark  -DinteractiveMode<span class=o>=</span><span class=nb>false</span>
</code></pre></div></li> <li>Utiliser le fichier POM suivant: <div class=highlight><pre><span></span><code><span class=nt>&lt;project</span> <span class=na>xmlns=</span><span class=s>&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class=na>xmlns:xsi=</span><span class=s>&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class=na>xsi:schemaLocation=</span><span class=s>&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span><span class=nt>&gt;</span>
  <span class=nt>&lt;modelVersion&gt;</span>4.0.0<span class=nt>&lt;/modelVersion&gt;</span>
  <span class=nt>&lt;groupId&gt;</span>tn.insat.tp4<span class=nt>&lt;/groupId&gt;</span>
  <span class=nt>&lt;artifactId&gt;</span>hbase-spark<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;packaging&gt;</span>jar<span class=nt>&lt;/packaging&gt;</span>
  <span class=nt>&lt;version&gt;</span>1<span class=nt>&lt;/version&gt;</span>
  <span class=nt>&lt;name&gt;</span>hbase-spark<span class=nt>&lt;/name&gt;</span>
  <span class=nt>&lt;url&gt;</span>http://maven.apache.org<span class=nt>&lt;/url&gt;</span>
  <span class=nt>&lt;build&gt;</span>
        <span class=nt>&lt;plugins&gt;</span>
            <span class=nt>&lt;plugin&gt;</span>
                <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
                <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>
                <span class=nt>&lt;configuration&gt;</span>
                    <span class=nt>&lt;source&gt;</span>1.8<span class=nt>&lt;/source&gt;</span>
                    <span class=nt>&lt;target&gt;</span>1.8<span class=nt>&lt;/target&gt;</span>
                <span class=nt>&lt;/configuration&gt;</span>
            <span class=nt>&lt;/plugin&gt;</span>
        <span class=nt>&lt;/plugins&gt;</span>
    <span class=nt>&lt;/build&gt;</span>

    <span class=nt>&lt;dependencies&gt;</span>

      <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.hbase<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>hbase<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>2.5.8<span class=nt>&lt;/version&gt;</span>
            <span class=nt>&lt;type&gt;</span>pom<span class=nt>&lt;/type&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.hbase<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>hbase-spark<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>2.0.0-alpha4<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.spark<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spark-core_2.13<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;version&gt;</span>3.5.0<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
    <span class=nt>&lt;/dependencies&gt;</span>
<span class=nt>&lt;/project&gt;</span>
</code></pre></div></li> <li>Créer la classe tn.insat.tp4.HbaseSparkProcess dont le code est le suivant: <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nn>tn.insat.tp4</span><span class=p>;</span>

<span class=kn>import</span> <span class=nn>org.apache.hadoop.conf.Configuration</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.HBaseConfiguration</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.client.Result</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.io.ImmutableBytesWritable</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.hadoop.hbase.mapreduce.TableInputFormat</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.SparkConf</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.api.java.JavaPairRDD</span><span class=p>;</span>
<span class=kn>import</span> <span class=nn>org.apache.spark.api.java.JavaSparkContext</span><span class=p>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>HbaseSparkProcess</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>createHbaseTable</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>Configuration</span> <span class=n>config</span> <span class=o>=</span> <span class=n>HBaseConfiguration</span><span class=p>.</span><span class=na>create</span><span class=p>();</span>
        <span class=n>SparkConf</span> <span class=n>sparkConf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SparkConf</span><span class=p>().</span><span class=na>setAppName</span><span class=p>(</span><span class=s>&quot;SparkHBaseTest&quot;</span><span class=p>).</span><span class=na>setMaster</span><span class=p>(</span><span class=s>&quot;local[4]&quot;</span><span class=p>);</span>
        <span class=n>JavaSparkContext</span> <span class=n>jsc</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JavaSparkContext</span><span class=p>(</span><span class=n>sparkConf</span><span class=p>);</span>

        <span class=n>config</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>TableInputFormat</span><span class=p>.</span><span class=na>INPUT_TABLE</span><span class=p>,</span><span class=s>&quot;sales_ledger&quot;</span><span class=p>);</span>

        <span class=n>JavaPairRDD</span><span class=o>&lt;</span><span class=n>ImmutableBytesWritable</span><span class=p>,</span> <span class=n>Result</span><span class=o>&gt;</span> <span class=n>hBaseRDD</span> <span class=o>=</span>
                <span class=n>jsc</span><span class=p>.</span><span class=na>newAPIHadoopRDD</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>TableInputFormat</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>ImmutableBytesWritable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Result</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>

        <span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;nombre d&#39;enregistrements: &quot;</span><span class=o>+</span><span class=n>hBaseRDD</span><span class=p>.</span><span class=na>count</span><span class=p>());</span>

    <span class=p>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=p>){</span>
        <span class=n>HbaseSparkProcess</span> <span class=n>admin</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HbaseSparkProcess</span><span class=p>();</span>
        <span class=n>admin</span><span class=p>.</span><span class=na>createHbaseTable</span><span class=p>();</span>
    <span class=p>}</span>

<span class=p>}</span>
</code></pre></div> Ce code permet de lire la table <em>sales_ledger</em> que nous avions précédemment créée, puis de créer un RDD en mémoire la représentant. Un Job spark permettra de compter le nombre d'éléments dans la base.</li> <li>Faire un <code>mvn clean package</code> sur le projet. Un fichier <em>hbase-spark-1.jar</em> sera créé sous le répertoire target du projet.</li> <li>Copier tous les fichiers de la bibliothèque hbase dans le répertoire jars de spark: <div class=highlight><pre><span></span><code>cp -r <span class=nv>$HBASE_HOME</span>/lib/* <span class=nv>$SPARK_HOME</span>/jars
</code></pre></div></li> <li>Exécuter ce fichier grâce à <em>spark-submit</em> comme suit: <div class=highlight><pre><span></span><code>spark-submit  --class tn.insat.tp4.HbaseSparkProcess --master yarn --deploy-mode client processing-1.jar
</code></pre></div> Le résultat qui devra s'afficher ressemblera au suivant: <center> <img alt="HBase et Spark Resultat" src=../img/tp4/hbase-spark-res.png> </center></li> </ol> <div class="admonition question"> <p class=admonition-title>Activité</p> <p>Explorer l'utilitaire d'import de données <em>ImportTsv</em> de HBase, et donner les étapes nécessaires pour l'intégrer et le tester dans votre environnement.</p> </div> <h3 id=homework>Homework<a class=headerlink href=#homework title="Permanent link">&para;</a></h3> <p>Pour la phase finale de votre projet, intégrez une base de données NOSQL. Cela peut être HBase, ou bien toute autre base telle que MongoDB ou Cassandra. L'objectif est de stocker dans cette base le résultat des traitements réalisés précédemment. Il est ensuite demandé d'utiliser un outil de visualisation de votre choix pour afficher des courbes ou graphes.</p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2024-04-24T20:48:15+01:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-04-24</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../tp3/ class="md-footer__link md-footer__link--prev" aria-label="Previous: TP3 - La Collecte de Données avec le Bus Kafka" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> TP3 - La Collecte de Données avec le Bus Kafka </div> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2017 - 2024 Lilia Sfaxi </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script> <script src=../assets/javascripts/bundle.e3b2bf44.min.js></script> <script src=../js/timeago.min.js></script> <script src=../js/timeago_mkdocs_material.js></script> </body> </html>