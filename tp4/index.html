
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Les Travaux Pratiques du cours Big Data">
      
      
        <link rel="canonical" href="http://INSATunisia.github.io/TP-BigData/tp4/">
      
      
        <meta name="author" content="Lilia Sfaxi">
      
      
        <link rel="shortcut icon" href="../img/favicon.ico">
      
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-1.7.1">
    
    
      
        <title>TP4 - TP Big Data</title>
      
    
    
      <script src="../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-2421e7e627.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-8817cfa535.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    

    <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
    <link rel="stylesheet" href="../css/highlight.css">
    <link rel="stylesheet" href="../css/codehilite.css">
    <link rel="stylesheet" href="../css/tooltip.css">

    <link rel="stylesheet" href="../css/customizations.css">
    <link rel="stylesheet" href="../css/site-customizations.css">
  </head>
  
  
  
  
    <body data-md-color-primary="blue" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="http://INSATunisia.github.io/TP-BigData/" title="TP Big Data" class="md-logo md-header-nav__button">
            <img src="../img/logo.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            TP4
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/INSATunisia/TP-BigData/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      INSATunisia/TP-BigData
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../img/logo.png">
      </i>
    
    TP Big Data
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/INSATunisia/TP-BigData/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      INSATunisia/TP-BigData
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Travaux Pratiques Big Data" class="md-nav__link">
      Travaux Pratiques Big Data
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tp1/" title="TP1" class="md-nav__link">
      TP1
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tp2/" title="TP2" class="md-nav__link">
      TP2
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tp3/" title="TP3" class="md-nav__link">
      TP3
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        TP4
      </label>
    
    <a href="./" title="TP4" class="md-nav__link md-nav__link--active">
      TP4
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#telecharger-pdf" title="Télécharger PDF" class="md-nav__link">
    Télécharger PDF
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectifs-du-tp" title="Objectifs du TP" class="md-nav__link">
    Objectifs du TP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outils-et-versions" title="Outils et Versions" class="md-nav__link">
    Outils et Versions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apache-hbase" title="Apache HBase" class="md-nav__link">
    Apache HBase
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#presentation" title="Présentation" class="md-nav__link">
    Présentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modele-de-donnees" title="Modèle de données" class="md-nav__link">
    Modèle de données
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#premiere-manipulation-de-hbase" title="Première manipulation de HBase" class="md-nav__link">
    Première manipulation de HBase
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hbase-shell" title="HBase Shell" class="md-nav__link">
    HBase Shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hbase-api" title="HBase API" class="md-nav__link">
    HBase API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chargement-de-fichiers" title="Chargement de fichiers" class="md-nav__link">
    Chargement de fichiers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#traitement-de-donnees-avec-spark" title="Traitement de données avec Spark" class="md-nav__link">
    Traitement de données avec Spark
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#telecharger-pdf" title="Télécharger PDF" class="md-nav__link">
    Télécharger PDF
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectifs-du-tp" title="Objectifs du TP" class="md-nav__link">
    Objectifs du TP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outils-et-versions" title="Outils et Versions" class="md-nav__link">
    Outils et Versions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apache-hbase" title="Apache HBase" class="md-nav__link">
    Apache HBase
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#presentation" title="Présentation" class="md-nav__link">
    Présentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modele-de-donnees" title="Modèle de données" class="md-nav__link">
    Modèle de données
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#premiere-manipulation-de-hbase" title="Première manipulation de HBase" class="md-nav__link">
    Première manipulation de HBase
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hbase-shell" title="HBase Shell" class="md-nav__link">
    HBase Shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hbase-api" title="HBase API" class="md-nav__link">
    HBase API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chargement-de-fichiers" title="Chargement de fichiers" class="md-nav__link">
    Chargement de fichiers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#traitement-de-donnees-avec-spark" title="Traitement de données avec Spark" class="md-nav__link">
    Traitement de données avec Spark
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/INSATunisia/TP-BigData/edit/master/docs/tp4.md" title="Edit this page" class="md-icon md-content__icon">edit</a>
                
                
                <h1 id="tp4-stockage-de-donnees-dans-une-base-nosql-avec-hbase">TP4 - Stockage de Données dans une Base NOSQL avec HBase<a class="headerlink" href="#tp4-stockage-de-donnees-dans-une-base-nosql-avec-hbase" title="Permanent link">&para;</a></h1>
<p><center><img alt="Distributed Data Base" src="../img/ddb.jpg" /></center></p>
<h2 id="telecharger-pdf">Télécharger PDF<a class="headerlink" href="#telecharger-pdf" title="Permanent link">&para;</a></h2>
<p><a href="../tp4.pdf"><img alt="Download TP4" src="../img/pdf.png" /></a></p>
<h2 id="objectifs-du-tp">Objectifs du TP<a class="headerlink" href="#objectifs-du-tp" title="Permanent link">&para;</a></h2>
<p>Manipulation de données avec HBase, et traitement co-localisé avec Spark.</p>
<h2 id="outils-et-versions">Outils et Versions<a class="headerlink" href="#outils-et-versions" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://hbase.apache.org/">Apache HBase</a> Version 1.4.7 </li>
<li><a href="http://hadoop.apache.org/">Apache Hadoop</a> Version: 2.7.2</li>
<li><a href="https://spark.apache.org/">Apache Spark</a> Version: 2.2.1</li>
<li><a href="https://www.docker.com/">Docker</a> Version 17.09.1</li>
<li><a href="https://www.jetbrains.com/idea/download/">IntelliJ IDEA</a> Version Ultimate 2016.1 (ou tout autre IDE de votre choix)</li>
<li><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java</a> Version 1.8</li>
<li>Unix-like ou Unix-based Systems (Divers Linux et MacOS)</li>
</ul>
<h2 id="apache-hbase">Apache HBase<a class="headerlink" href="#apache-hbase" title="Permanent link">&para;</a></h2>
<h3 id="presentation">Présentation<a class="headerlink" href="#presentation" title="Permanent link">&para;</a></h3>
<p>HBase est un système de gestion de bases de données distribué, non-relationnel et orienté colonnes, développé au-dessus du système de fichier HDFS.<br />
Il permet un accès aléatoire en écriture/lecture en temps réel à un très grand ensemble de données.<br />
<center><br />
<img alt="Apache HBase" src="../img/hbase.png" /><br />
</center></p>
<h3 id="modele-de-donnees">Modèle de données<a class="headerlink" href="#modele-de-donnees" title="Permanent link">&para;</a></h3>
<p>Le modèle se base sur six concepts, qui sont :</p>
<ul>
<li><strong>Table</strong> : dans HBase les données sont organisées dans des tables. Les noms des tables sont des chaînes de caractères.</li>
<li><strong>Row</strong> : dans chaque table, les données sont organisées dans des lignes. Une ligne est identifiée par une clé unique (<em>RowKey</em>). La Rowkey n’a pas de type, elle est traitée comme un tableau d’octets.</li>
<li><strong>Column Family</strong> : Les données au sein d’une ligne sont regroupées par <em>column family</em>. Chaque ligne de la table a les mêmes column families, qui peuvent être peuplées ou pas. Les column families sont définies à la création de la table dans HBase. Les noms des column families sont des chaînes de caractères.</li>
<li><strong>Column qualifier</strong> : L’accès aux données au sein d’une column family se fait via le <em>column qualifier</em> ou <em>column</em>. Ce dernier n’est pas spécifié à la création de la table mais plutôt à l’insertion de la donnée. Comme les rowkeys, le column qualifier n’est pas typé, il est traité comme un tableau d’octets.</li>
<li><strong>Cell</strong> : La combinaison du RowKey, de la Column Family ainsi que la Column qualifier identifie d’une manière unique une cellule. Les données stockées dans une cellule sont appelées les <em>valeurs</em> de cette cellule. Les valeurs n’ont pas de type, ils sont toujours considérés comme tableaux d’octets.</li>
<li><strong>Version</strong> : Les valeurs au sein d’une cellule sont versionnés. Les versions sont identifiés par leur <em>timestamp</em> (de type long). Le nombre de versions est configuré via la Column Family. Par défaut, ce nombre est égal à trois.</li>
</ul>
<p><center><br />
<img alt="Modèle de données de HBase" src="../img/tp4/hbase-model.jpg" /><br />
</center></p>
<p>Les données dans HBase sont stockées sous forme de <em>HFiles</em>, par colonnes, dans HDFS. Chaque <em>HFile</em> se charge de stocker des données correspondantes à une <em>column family</em> particulière.</p>
<p><center><br />
<img alt="HFile" src="../img/tp4/hbase-hfile.png" /><br />
</center></p>
<p>Autres caractéristiques de HBase:</p>
<ul>
<li>HBase n'a pas de schéma prédéfini, sauf qu'il faut définir les familles de colonnes à la création des tables, car elles représentent l'organisation physique des données</li>
<li>HBase est décrite comme étant un magasin de données clef/valeur, où la clef est la combinaison (<em>row</em>-<em>column family</em>-<em>column</em>-<em>timestamp</em>) représente la clef, et la <em>cell</em> représente la valeur.</li>
</ul>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<p>Physiquement, HBase est composé de trois types de serveurs de type Master/Slave.</p>
<ul>
<li><strong>Region Servers</strong>: permettent de fournir les données pour lectures et écritures. Pour accéder aux données, les clients communiquent avec les RegionServers directement.</li>
<li><strong>HBase HMaster</strong> : gère l'affectation des régions, les opérations de création et suppression de tables.</li>
<li><strong>Zookeeper</strong>: permet de maintenir le cluster en état.</li>
</ul>
<p>Le DataNode de Hadoop permet de stocker les données que le Region Server gère. Toutes les données de HBase sont stockées dans des fichiers HDFS. Les RegionServers sont colocalisés avec les DataNodes.</p>
<p>Le NameNode permet de maintenir les métadonnées sur tous les blocs physiques qui forment les fichiers.</p>
<p><center><br />
<img alt="Architecture de HBase" src="../img/tp4/hbase-archi.png" /><br />
</center></p>
<p>Les tables HBase sont divisées horizontalement, par <em>row</em> en plusieurs <strong>Regions</strong>. Une region contient toutes les lignes de la table comprises entre deux clefs données. Les regions sont affectées à des noeuds dans le cluster, appelés <em>Region Servers</em>, qui permettent de servir les données pour la lecture et l'écriture. Un <em>region server</em> peut servir jusqu'à 1000 régions.</p>
<p>Le HBase Master est responsable de coordonner les <em>region servers</em> en assignant les régions au démarrage, les réassignant en cas de récupération ou d'équilibrage de charge, et en faisant le monitoring des instances des <em>region servers</em> dans le cluster. Il permet également de fournir une interface pour la création, la suppression et la modification des tables.</p>
<p>HBase utilise Zookeeper comme service de coordination pour maintenir l'état du serveur dans le cluster. Zookeeper sait quels serveurs sont actifs et disponibles, et fournit une notification en cas d'échec d'un serveur.</p>
<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h3>
<p>HBase est installé sur le même cluster que précédemment.  Si vous disposez des contenaires, vous n'avez rien à faire. Sinon, vous pourrez les installer avec Docker comme suit:</p>
<ol>
<li>Cloner le repo github contenant les fichiers nécessaires pour le lancement des contenaires et leur configuration:<br />
<div class="codehilite"><pre><span></span>  git clone https://github.com/liliasfaxi/hadoop-cluster-docker
</pre></div></li>
<li>Construire l'image Docker à partir du fichier Dockerfile fourni.<br />
<div class="codehilite"><pre><span></span>  <span class="nb">cd</span> hadoop-cluster-docker
  ./build-image.sh
</pre></div></li>
<li>Démarrer les trois contenaires:<br />
<div class="codehilite"><pre><span></span>  sudo ./start-container.sh
</pre></div><br />
Le résultat de cette exécution sera le suivant:<br />
<div class="codehilite"><pre><span></span>  start hadoop-master container...
  start hadoop-slave1 container...
  start hadoop-slave2 container...
  root@hadoop-master:~#
</pre></div></li>
<li>Lancer Hadoop en tapant :<br />
<div class="codehilite"><pre><span></span>  ./start-hadoop.sh
</pre></div></li>
<li>Lancer HBase en tapant :<br />
<div class="codehilite"><pre><span></span>  start-hbase.sh
</pre></div></li>
</ol>
<p>Une fois c'est fait, en tapant <code>jps</code>, vous devriez avoir un résultat ressemblant au suivant:</p>
<p><div class="codehilite"><pre><span></span><span class="m">161</span> NameNode
<span class="m">1138</span> HRegionServer
<span class="m">499</span> ResourceManager
<span class="m">1028</span> HMaster
<span class="m">966</span> HQuorumPeer
<span class="m">1499</span> Jps
<span class="m">348</span> SecondaryNameNode
</pre></div><br />
Vous remarquerez que tous les démons Hadoop (NameNode, SecondaryNameNode et ResourceManager) ainsi que les démons HBase (HRegionServer, HMaster et HQuorumPeer (Zookeeper)) sont démarrés.</p>
<h2 id="premiere-manipulation-de-hbase">Première manipulation de HBase<a class="headerlink" href="#premiere-manipulation-de-hbase" title="Permanent link">&para;</a></h2>
<h3 id="hbase-shell">HBase Shell<a class="headerlink" href="#hbase-shell" title="Permanent link">&para;</a></h3>
<p>Pour manipuler votre base de données avec son shell interactif, vous devez lancer le script suivant:<br />
<div class="codehilite"><pre><span></span>  hbase shell
</pre></div></p>
<p>Vous obtiendrez une interface ressemblant à la suivante:<br />
<center><br />
<img alt="HBase shell" src="../img/tp4/hbase-shell.png" /><br />
</center></p>
<p>Nous allons créer une base de données qui contient les données suivantes:</p>
<p><center><br />
<img alt="HBase Exemple" src="../img/tp4/hbase-table-1.png" /><br />
</center></p>
<ol>
<li>Commençons par créer la table, ainsi que les familles de colonnes associées:<br />
<div class="codehilite"><pre><span></span>create <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;customer&#39;</span>,<span class="s1">&#39;sales&#39;</span>
</pre></div></li>
<li>Vérifier que la table est bien créée:<br />
<div class="codehilite"><pre><span></span>list
</pre></div><br />
Vous devriez obtenir le résultat suivant:<br />
<center><br />
<img alt="HBase shell list" src="../img/tp4/hbase-list.png" /><br />
</center></li>
<li>Insérer les différentes lignes:<br />
<div class="codehilite"><pre><span></span>put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;101&#39;</span>,<span class="s1">&#39;customer:name&#39;</span>,<span class="s1">&#39;John White&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;101&#39;</span>,<span class="s1">&#39;customer:city&#39;</span>,<span class="s1">&#39;Los Angeles, CA&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;101&#39;</span>,<span class="s1">&#39;sales:product&#39;</span>,<span class="s1">&#39;Chairs&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;101&#39;</span>,<span class="s1">&#39;sales:amount&#39;</span>,<span class="s1">&#39;$400.00&#39;</span>

put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;102&#39;</span>,<span class="s1">&#39;customer:name&#39;</span>,<span class="s1">&#39;Jane Brown&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;102&#39;</span>,<span class="s1">&#39;customer:city&#39;</span>,<span class="s1">&#39;Atlanta, GA&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;102&#39;</span>,<span class="s1">&#39;sales:product&#39;</span>,<span class="s1">&#39;Lamps&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;102&#39;</span>,<span class="s1">&#39;sales:amount&#39;</span>,<span class="s1">&#39;$200.00&#39;</span>

put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;103&#39;</span>,<span class="s1">&#39;customer:name&#39;</span>,<span class="s1">&#39;Bill Green&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;103&#39;</span>,<span class="s1">&#39;customer:city&#39;</span>,<span class="s1">&#39;Pittsburgh, PA&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;103&#39;</span>,<span class="s1">&#39;sales:product&#39;</span>,<span class="s1">&#39;Desk&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;103&#39;</span>,<span class="s1">&#39;sales:amount&#39;</span>,<span class="s1">&#39;$500.00&#39;</span>

put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;104&#39;</span>,<span class="s1">&#39;customer:name&#39;</span>,<span class="s1">&#39;Jack Black&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;104&#39;</span>,<span class="s1">&#39;customer:city&#39;</span>,<span class="s1">&#39;St. Louis, MO&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;104&#39;</span>,<span class="s1">&#39;sales:product&#39;</span>,<span class="s1">&#39;Bed&#39;</span>
put <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;104&#39;</span>,<span class="s1">&#39;sales:amount&#39;</span>,<span class="s1">&#39;$1,600.00&#39;</span>
</pre></div></li>
<li>Visualiser le résultat de l'insertion, en tapant:<br />
<div class="codehilite"><pre><span></span>scan <span class="s1">&#39;sales_ledger&#39;</span>
</pre></div><br />
<center><br />
<img alt="HBase shell scan" src="../img/tp4/hbase-scan.png" /><br />
</center></li>
<li>Afficher les valeurs de la colonne <em>product</em> de la ligne <em>102</em><br />
<div class="codehilite"><pre><span></span>get <span class="s1">&#39;sales_ledger&#39;</span>,<span class="s1">&#39;102&#39;</span>,<span class="o">{</span><span class="nv">COLUMN</span> <span class="o">=</span>&gt; <span class="s1">&#39;sales:product&#39;</span><span class="o">}</span>
</pre></div><br />
Vous obtiendrez:<br />
<center><br />
<img alt="HBase shell get" src="../img/tp4/hbase-get.png" /><br />
</center></li>
<li>Vous pourrez quitter le shell en tapant:<br />
<div class="codehilite"><pre><span></span><span class="nb">exit</span>
</pre></div></li>
</ol>
<h3 id="hbase-api">HBase API<a class="headerlink" href="#hbase-api" title="Permanent link">&para;</a></h3>
<p>HBase fournit une API en Java pour pouvoir manipuler programmatiquement les données de la base. Nous allons montrer ici un exemple très simple.</p>
<ol>
<li>Dans votre contenaire principal, créer un répertoire <em>hbase-code</em> à l'emplacement de votre choix, puis déplacez-vous dedans.<br />
<div class="codehilite"><pre><span></span>mkdir hbase-code
<span class="nb">cd</span> hbase-code
</pre></div></li>
<li>Créer l'arborescence <em>tn/insat/tp4</em> dans ce répertoire:<br />
<div class="codehilite"><pre><span></span>mkdir -p tn/insat/tp4
</pre></div></li>
<li>Créer et ouvrir le fichier <em>HelloHBase.java</em> sous le répertoire tp4:<br />
<div class="codehilite"><pre><span></span>vim tn/insat/tp4/HelloHBase.java
</pre></div></li>
<li>
<p>Insérer le code suivant dans le fichier:<br />
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tp4</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.hadoop.conf.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.HBaseConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.HColumnDescriptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.HTableDescriptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.TableName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.client.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.util.Bytes</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloHBase</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Table</span> <span class="n">table1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">tableName</span> <span class="o">=</span> <span class="s">&quot;user&quot;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">family1</span> <span class="o">=</span> <span class="s">&quot;PersonalData&quot;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">family2</span> <span class="o">=</span> <span class="s">&quot;ProfessionalData&quot;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createHbaseTable</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">Configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="n">HBaseConfiguration</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
        <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">ConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
        <span class="n">Admin</span> <span class="n">admin</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getAdmin</span><span class="o">();</span>

        <span class="n">HTableDescriptor</span> <span class="n">ht</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HTableDescriptor</span><span class="o">(</span><span class="n">TableName</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">tableName</span><span class="o">));</span>
        <span class="n">ht</span><span class="o">.</span><span class="na">addFamily</span><span class="o">(</span><span class="k">new</span> <span class="n">HColumnDescriptor</span><span class="o">(</span><span class="n">family1</span><span class="o">));</span>
        <span class="n">ht</span><span class="o">.</span><span class="na">addFamily</span><span class="o">(</span><span class="k">new</span> <span class="n">HColumnDescriptor</span><span class="o">(</span><span class="n">family2</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;connecting&quot;</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Creating Table&quot;</span><span class="o">);</span>
        <span class="n">createOrOverwrite</span><span class="o">(</span><span class="n">admin</span><span class="o">,</span> <span class="n">ht</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Done......&quot;</span><span class="o">);</span>

        <span class="n">table1</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getTable</span><span class="o">(</span><span class="n">TableName</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">tableName</span><span class="o">));</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Adding user: user1&quot;</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">row1</span> <span class="o">=</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;user1&quot;</span><span class="o">);</span>
            <span class="n">Put</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Put</span><span class="o">(</span><span class="n">row1</span><span class="o">);</span>

            <span class="n">p</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family1</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;name&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;ahmed&quot;</span><span class="o">));</span>
            <span class="n">p</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family1</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;address&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;tunis&quot;</span><span class="o">));</span>
            <span class="n">p</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;company&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;biat&quot;</span><span class="o">));</span>
            <span class="n">p</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;salary&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;10000&quot;</span><span class="o">));</span>
            <span class="n">table1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Adding user: user2&quot;</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">row2</span> <span class="o">=</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;user2&quot;</span><span class="o">);</span>
            <span class="n">Put</span> <span class="n">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Put</span><span class="o">(</span><span class="n">row2</span><span class="o">);</span>
            <span class="n">p2</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family1</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;name&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;imen&quot;</span><span class="o">));</span>
            <span class="n">p2</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family1</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;tel&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;21212121&quot;</span><span class="o">));</span>
            <span class="n">p2</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;profession&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;educator&quot;</span><span class="o">));</span>
            <span class="n">p2</span><span class="o">.</span><span class="na">addColumn</span><span class="o">(</span><span class="n">family2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;company&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="s">&quot;insat&quot;</span><span class="o">));</span>
            <span class="n">table1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">p2</span><span class="o">);</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;reading data...&quot;</span><span class="o">);</span>
            <span class="n">Get</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Get</span><span class="o">(</span><span class="n">row1</span><span class="o">);</span>

            <span class="n">Result</span> <span class="n">r</span> <span class="o">=</span> <span class="n">table1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">g</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">family1</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">&quot;name&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">())));</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">table1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createOrOverwrite</span><span class="o">(</span><span class="n">Admin</span> <span class="n">admin</span><span class="o">,</span> <span class="n">HTableDescriptor</span> <span class="n">table</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">admin</span><span class="o">.</span><span class="na">tableExists</span><span class="o">(</span><span class="n">table</span><span class="o">.</span><span class="na">getTableName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">admin</span><span class="o">.</span><span class="na">disableTable</span><span class="o">(</span><span class="n">table</span><span class="o">.</span><span class="na">getTableName</span><span class="o">());</span>
            <span class="n">admin</span><span class="o">.</span><span class="na">deleteTable</span><span class="o">(</span><span class="n">table</span><span class="o">.</span><span class="na">getTableName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">admin</span><span class="o">.</span><span class="na">createTable</span><span class="o">(</span><span class="n">table</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">HelloHBase</span> <span class="n">admin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HelloHBase</span><span class="o">();</span>
        <span class="n">admin</span><span class="o">.</span><span class="na">createHbaseTable</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div><br />
Ce code permet de réaliser les opérations suivantes:<br />
  4.1. Créer une table appelée "<em>user</em>" contenant deux familles de colonnes: "<em>PersonalData</em>" et "<em>ProfessionalData</em>". Si cette table existe déjà, elle sera écrasée.<br />
  4.2. Insérer deux enregistrements dans cette table.<br />
  4.3. Lire la valeur de la colonne 'PersonalData:name' de la ligne 'user1'</p>
</li>
<li>
<p>Tout en restant sous le répertoire <em>hbase-code</em>, compiler cette classe:<br />
<div class="codehilite"><pre><span></span>javac tn/insat/tp4/HelloHBase.java
</pre></div></p>
</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Remarque</p>
<p>Ce code devrait compiler sans problèmes, car la librairie HBase est déjà incluse dans le classpath par défaut, grâce à la variable d'environnement $CLASSPATH.</p>
</div>
<p>Exécuter ce code:<br />
  <div class="codehilite"><pre><span></span>java tn.insat.tp4.HelloHBase
</pre></div><br />
Le résultat devrait ressembler au suivant:<br />
<center><br />
<img alt="HBase API result" src="../img/tp4/hbase-api.png" /><br />
</center></p>
<h2 id="chargement-de-fichiers">Chargement de fichiers<a class="headerlink" href="#chargement-de-fichiers" title="Permanent link">&para;</a></h2>
<p>Il est possible de charger des fichiers volumineux dans la base HBase, à partir de HDFS. Nous vous fournissons pour cela le fichier <em>purchases2.txt</em> que vous trouverez directement sous le répertoire /root de votre contenaire.</p>
<div class="admonition tip">
<p class="admonition-title">Remarque</p>
<p>Ce fichier n'est autre que le fichier <em>purchases.txt</em>, légèrement modifié: un numéro unique est rajouté au début de chaque ligne, que nous utiliserons comme clef pour chaque enregistrement, et la séparation entre les colonnes a été remplacée par une virgule (,) au lieu d'une tabluation.</p>
</div>
<ol>
<li>Commencer par charger le fichier dans le répertoire <em>input</em> de HDFS (mais d'abord, créer ce répertoire s'il n'existe pas déjà):<br />
<div class="codehilite"><pre><span></span>hadoop fs -mkdir -p input
hadoop fs -put purchases2.txt input
</pre></div></li>
<li>Créer la base <em>products</em> avec une famille de colonnes <em>cf</em><br />
<div class="codehilite"><pre><span></span>hbase shell
create <span class="s1">&#39;products&#39;</span>,<span class="s1">&#39;cf&#39;</span>
<span class="nb">exit</span>
</pre></div></li>
<li>Exécuter la commande suivante. <em>ImportTsv</em> est une utilité qui permet de charger des données au format <em>tsv</em> dans HBase. Elle permet de déclencher une opération MapReduce sur le fichier principal stocké dans HDFS, pour lire les données puis les insérer via des <em>put</em> dans la base.<br />
<div class="codehilite"><pre><span></span>hbase org.apache.hadoop.hbase.mapreduce.ImportTsv <span class="se">\</span>
    -Dimporttsv.separator<span class="o">=</span><span class="s1">&#39;,&#39;</span> <span class="se">\</span>
    -Dimporttsv.columns<span class="o">=</span>HBASE_ROW_KEY,cf:date,cf:time,cf:town,cf:product,cf:price,cf:payment <span class="se">\</span>
    products input
</pre></div></li>
<li>Vérifier que la base a bien été créée en consultant la ville de l'enregistrement numéro 2000:<br />
<div class="codehilite"><pre><span></span>hbase shell
get <span class="s1">&#39;products&#39;</span>,<span class="s1">&#39;2000&#39;</span>,<span class="o">{</span><span class="nv">COLUMN</span> <span class="o">=</span>&gt; <span class="s1">&#39;cf:town&#39;</span><span class="o">}</span>
</pre></div><br />
Vous devriez obtenir le résultat suivant:<br />
<center><br />
<img alt="HBase Bulk Load" src="../img/tp4/hbase-bulk.png" /><br />
</center></li>
</ol>
<h2 id="traitement-de-donnees-avec-spark">Traitement de données avec Spark<a class="headerlink" href="#traitement-de-donnees-avec-spark" title="Permanent link">&para;</a></h2>
<p>Installé sur le même cluster que HBase, Spark peut être utilisé pour réaliser des traitements complexes sur les données de HBase. Pour cela, les différents Executors de Spark seront co-localisés avec les region servers, et pourront réaliser des traitements parallèles directement là où les données sont stockées.</p>
<p><center><br />
<img alt="HBase et Spark" src="../img/tp4/hbase-spark.png" /><br />
</center></p>
<p>Nous allons réaliser un traitement simple pour montrer comment greffer spark sur HBase.</p>
<ol>
<li>Ouvrir IntelliJ IDEA, et créer un nouveau projet Maven.</li>
<li>Utiliser le fichier POM suivant:<br />
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>hbase.spark<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>processing<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
                    <span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.hbase<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hbase-spark<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.0.0-alpha4<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.spark<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spark-core_2.11<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.2.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div></li>
<li>Créer la classe tn.insat.tp4.HbaseSparkProcess dont le code est le suivant:<br />
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">tn.insat.tp4</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.hadoop.conf.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.HBaseConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.client.Result</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.io.ImmutableBytesWritable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.hadoop.hbase.mapreduce.TableInputFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.SparkConf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.api.java.JavaPairRDD</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.api.java.JavaSparkContext</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HbaseSparkProcess</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createHbaseTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="n">HBaseConfiguration</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
        <span class="n">SparkConf</span> <span class="n">sparkConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SparkConf</span><span class="o">().</span><span class="na">setAppName</span><span class="o">(</span><span class="s">&quot;SparkHBaseTest&quot;</span><span class="o">).</span><span class="na">setMaster</span><span class="o">(</span><span class="s">&quot;local[4]&quot;</span><span class="o">);</span>
        <span class="n">JavaSparkContext</span> <span class="n">jsc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JavaSparkContext</span><span class="o">(</span><span class="n">sparkConf</span><span class="o">);</span>

        <span class="n">config</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">TableInputFormat</span><span class="o">.</span><span class="na">INPUT_TABLE</span><span class="o">,</span><span class="s">&quot;products&quot;</span><span class="o">);</span>

        <span class="n">JavaPairRDD</span><span class="o">&lt;</span><span class="n">ImmutableBytesWritable</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span> <span class="n">hBaseRDD</span> <span class="o">=</span>
                <span class="n">jsc</span><span class="o">.</span><span class="na">newAPIHadoopRDD</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">TableInputFormat</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ImmutableBytesWritable</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Result</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;nombre d&#39;enregistrements: &quot;</span><span class="o">+</span><span class="n">hBaseRDD</span><span class="o">.</span><span class="na">count</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">HbaseSparkProcess</span> <span class="n">admin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HbaseSparkProcess</span><span class="o">();</span>
        <span class="n">admin</span><span class="o">.</span><span class="na">createHbaseTable</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div><br />
Ce code permet de lire la table <em>products</em> que nous avions précédemment créée, puis de créer un RDD en mémoire la représentant. Un Job spark permettra de compter le nombre d'éléments dans la base.</li>
<li>Faire un <code>mvn install package</code> sur le projet. Un fichier <em>processing-1.jar</em> sera créé dans le répertoire target du projet.</li>
<li>Copier ce fichier dans votre contenaire:<br />
<div class="codehilite"><pre><span></span>docker cp target/processing-1.jar hadoop-master:/root/
</pre></div></li>
<li>Copier tous les fichiers de la bibliothèque hbase dans le répertoire jars de spark:<br />
<div class="codehilite"><pre><span></span>cp -r <span class="nv">$HBASE_HOME</span>/lib/* <span class="nv">$SPARK_HOME</span>/jars
</pre></div></li>
<li>Exécuter ce fichier grâce à <em>spark-submit</em> comme suit:<br />
<div class="codehilite"><pre><span></span>spark-submit  --class tn.insat.tp4.HbaseSparkProcess --master yarn --deploy-mode client processing-1.jar
</pre></div><br />
Le résultat qui devra s'afficher ressemblera au suivant:<br />
<center><br />
<img alt="HBase et Spark Resultat" src="../img/tp4/hbase-spark-res.png" /><br />
</center></li>
</ol>
<div class="admonition question">
<p class="admonition-title">Activité</p>
<p>Modifier ce code pour qu'il puisse faire la somme des ventes de tous les produits.</p>
</div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../tp3/" title="TP3" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                TP3
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 - 2018 Lilia Sfaxi
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="http://liliasfaxi.wix.com/liliasfaxi" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/liliasfaxi" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/lillitou" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/liliasfaxi/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/raphael-min.js"></script>
      <script src="../assets/javascripts/flowchart.js"></script>
      <script src="../assets/javascripts/application-e3caa82af6.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
        <script src="../search/require.js"></script>
      
        <script src="../search/search.js"></script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","None","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>